<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Didattica Hub - Sfida Achille e la Tartaruga</title>

  <meta name="author" content="Daniela Ippolito (@matefacile)">
  <meta name="copyright" content="¬© Daniela Ippolito (@matefacile)">

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#bfa100">
  <link rel="apple-touch-icon" href="icon-512.png">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script>
    window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] } };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root {
      --c-oro: #bfa100;
      --c-accento: #27ae60;
      --c-sfondo: #fdfbf7;
      --c-testo: #2c3e50;
      --c-errore: #e74c3c;
      --c-azzurro: #3498db;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; font-family: 'Inter', sans-serif; 
      background: var(--c-sfondo); color: var(--c-testo); 
      display: flex; flex-direction: column; min-height: 100vh;
      overflow-x: hidden;
    }

    /* Schermate */
    #category-screen, #menu-screen, #game-screen, #report-area { display: none; width: 100%; }

    /* Griglia delle materie (Pietre) */
    #category-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 30px;
      justify-items: center;
      align-items: center;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .category-card {
      width: 220px; height: 220px; aspect-ratio: 1 / 1;
      border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
      background-color: var(--c-oro); color: white;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center;
    }

    .category-card:hover {
      transform: scale(1.05) rotate(3deg);
      border-radius: 40% 60% 70% 30% / 40% 70% 30% 60%;
      box-shadow: 0 15px 30px rgba(0,0,0,0.2);
    }

    .category-card h2 { font-family: 'Cinzel', serif; font-size: 1.2rem; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3); text-transform: uppercase; }
    .category-card span { font-size: 0.8rem; margin-top: 10px; background: rgba(0,0,0,0.15); padding: 4px 12px; border-radius: 20px; font-weight: bold; }

    /* Lingua Toggle */
    .lang-toggle {
      display: flex; justify-content: center; gap: 10px; margin-bottom: 25px;
    }
    .lang-btn {
      border: 2px solid var(--c-oro); background: white; color: var(--c-testo);
      padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: 0.3s;
    }
    .lang-btn.active { background: var(--c-oro); color: white; }

    /* Menu Sfide */
    #sfide-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; width: 100%; margin-top: 30px; }
    .sfida-card { background: white; padding: 18px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); cursor: pointer; border-top: 6px solid var(--c-oro); transition: 0.2s; height: 160px; text-align: left; }
    .sfida-card:hover { transform: translateY(-4px); }
    .sfida-card h2 { margin: 0 0 10px 0; font-size: 1.1rem; color: var(--c-testo); }
    .sfida-card p { margin: 0; font-size: 0.85rem; color: #666; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }

    /* Header di Gioco */
    .header { 
      padding: 10px; border-bottom: 3px solid var(--c-oro); background: white; 
      position: sticky; top: 0; z-index: 1000; 
      display: grid; grid-template-columns: 1fr 1.5fr 1fr; align-items: center; 
    }
    .back-btn { background: none; border: none; font-size: 1.5rem; color: var(--c-oro); cursor: pointer; }

    /* Percorso di Gioco */
    #main-game-area { padding: 40px 0; }
    .vertical-track { position: relative; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; }
    .node-container { width: 100%; position: relative; z-index: 2; display: flex; margin: 18px 0; justify-content: center; }

    .node-container:nth-child(8n+1) { transform: translateX(-110px); }
    .node-container:nth-child(8n+2) { transform: translateX(-60px); }
    .node-container:nth-child(8n+3) { transform: translateX(60px); }
    .node-container:nth-child(8n+4) { transform: translateX(110px); }
    .node-container:nth-child(8n+5) { transform: translateX(110px); }
    .node-container:nth-child(8n+6) { transform: translateX(60px); }
    .node-container:nth-child(8n+7) { transform: translateX(-60px); }
    .node-container:nth-child(8n+8) { transform: translateX(-110px); }

    .node { width: 55px; height: 55px; border-radius: 50%; background: white; border: 4px solid var(--c-oro); display: flex; justify-content: center; align-items: center; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #ddd; transition: 0.2s; }
    .node.done { background: var(--c-accento); color: white; border-color: #1e8449; box-shadow: 0 4px 0 #1e8449; }
    .node.future { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }

    .avatar { position: absolute; font-size: 38px; z-index: 10; transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; top: 0; left: 0; }

    /* Modale Quiz */
    #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 3000; }
    #modal-content { background: white; padding: 25px; border-radius: 20px; width: 92%; max-width: 500px; text-align: center; max-height: 85vh; overflow-y: auto; }
    .btn-ans { background: var(--c-oro); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; margin: 10px auto; width: 100%; display: block; font-size: 1rem; }

    /* Report Area */
    #report-area { padding: 20px; background: white; text-align: center; }
    .report-table-container { overflow-x: auto; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: top; }
    th { background: var(--c-oro); color: white; }
    .theory-text { font-size: 0.85rem; color: #555; font-style: italic; display: block; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }

    /* Brand */
    .brand { display: flex; align-items: center; gap: 10px; color: #666; font-size: 0.82rem; }
    .brand img { width: 28px; height: 28px; object-fit: contain; border-radius: 6px; }
    .brand-home { justify-content: center; margin-top: 10px; }
    .brand-report { justify-content: center; margin: 8px 0 18px 0; }

    /* Mobile */
    @media (max-width: 480px) {
      .category-card { width: 180px; height: 180px; }
      #category-list { grid-template-columns: 1fr; }
      .header h1 { font-size: 0.7rem !important; }
    }

    @media print {
      .no-print { display: none !important; }
      #report-area { display: block !important; }
    }
  </style>
</head>
<body>

  <!-- SCHERMATA 1: CATEGORIE -->
  <div id="category-screen" style="padding: 40px 20px; max-width: 1200px; margin: 0 auto; display: block;">
    <div class="lang-toggle no-print">
      <button id="btn-lang-it" class="lang-btn" onclick="setLang('it')">üáÆüáπ Italiano</button>
      <button id="btn-lang-en" class="lang-btn" onclick="setLang('en')">üá¨üáß English</button>
    </div>
    <div class="logo-area">
      <h1 id="ui-main-title">Didattica Hub</h1>
      <div id="brand-cat"></div> 
    </div>
    <h2 id="ui-select-subject" style="text-align:center; font-family:'Cinzel'; color:var(--c-testo); margin-bottom:30px;">Seleziona Materia</h2>
    <div id="category-list"></div>
  </div>

  <!-- SCHERMATA 2: MENU SFIDE -->
  <div id="menu-screen">
    <div class="logo-area">
      <h1 id="ui-menu-title">Didattica Hub</h1>
      <div id="brand-home"></div>
    </div>
    <div id="sfide-list"></div>
    <!-- BLOCCO PULSANTI AZIONE -->
    <div class="no-print" style="display: flex; justify-content: center; gap: 15px; margin: 40px auto; max-width: 450px; padding: 0 20px;">
      <button id="ui-back-to-subjects" class="btn-ans" style="background: var(--c-azzurro); flex: 1; margin: 0;" onclick="currentMateria = null; renderCategories();">‚ùÆ TORNA</button>
      <button id="ui-reset-all" class="btn-ans" style="background: #7f8c8d; flex: 1; margin: 0;" onclick="resetTutto()">RESET GLOBALE</button>
    </div>
  </div>

  <!-- SCHERMATA 3: GIOCO -->
  <div id="game-screen">
    <div class="header no-print">
      <div style="display: flex; align-items: center; gap: 8px;">
        <button class="back-btn" onclick="tornaAlMenu()">‚ùÆ</button>
        <img src="logo2matefacile.png" alt="Logo" style="width: 35px; height: 35px; object-fit: contain;">
      </div>
      <div style="text-align: center;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 5px; color: var(--c-oro); font-weight: bold; font-size: 1.2rem;">
          <span>‚≠ê</span><span id="stars-count-header">0</span>
        </div>
        <h1 id="topic-title" style="font-family:'Cinzel'; font-size: 0.8rem; margin: 0; color: #666; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">...</h1>
      </div>
      <div style="text-align: right;">
        <button class="back-btn" onclick="resetGame()">üîÑ</button>
      </div>
    </div>
    <div id="main-game-area">
      <div class="vertical-track">
        <div id="achilles" class="avatar">üèÉ‚Äç‚ôÇÔ∏è</div>
        <div id="tortoise" class="avatar">üê¢</div>
        <div id="nodes-container" style="width:100%"></div>
      </div>
    </div>
  </div>

  <!-- SCHERMATA 4: REPORT -->
  <div id="report-area">
    <h1 id="ui-report-title" style="font-family:'Cinzel'; color: var(--c-oro);">Report Finale</h1>
    <div id="brand-report"></div>
    <h2 id="ui-final-stars-label">Stelle Totali: 0</h2>
    <div class="report-table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th id="th-q">Domanda</th>
            <th id="th-a">Risposta Corretta</th>
            <th id="th-t">Tentativi</th>
          </tr>
        </thead>
        <tbody id="report-body"></tbody>
      </table>
    </div>
    <div class="no-print" style="margin-top: 25px;">
      <button id="ui-print-btn" class="btn-ans" style="display:inline-block; width:auto; padding: 10px 30px;" onclick="window.print()">üñ®Ô∏è STAMPA REPORT</button>
      <button id="ui-home-btn" class="btn-ans" style="display:inline-block; width:auto; background:#7f8c8d; padding: 10px 30px;" onclick="tornaAlMenu()">üè† HOME</button>
    </div>
  </div>

  <!-- MODALE QUIZ -->
  <div id="modal-overlay">
    <div id="modal-content">
      <div id="quiz-container"></div>
      <div id="feedback-msg"></div>
    </div>
  </div>

  <audio id="snd-ok" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>
  <audio id="snd-no" src="https://www.myinstants.com/media/sounds/raspberry.mp3"></audio>

  <script>
    const URL_INDICE_SFIDE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo9ZeS6loicyVFU04pA29n5GxEeg3q7teyh2-Tsd4DUPzwjNyQsPE4OBwG7WF14rSdxbPeTn594i1D/pub?gid=892603852&single=true&output=csv";

    const BRAND = {
      name: "Daniela Ippolito", handle: "@matefacile", logo: "logo2matefacile.png", year: new Date().getFullYear()
    };

    let LANG = localStorage.getItem("lang") || "it";
    const I18N = {
      it: {
        selectSubject: "Seleziona Materia", resetAll: "RESET GLOBALE", backToSubjects: "‚ùÆ TORNA ALLE MATERIE",
        challenges: "SFIDE", completed: "completati", correct: "‚ú® Corretto!", wrong: "‚ùå Errato!", 
        attempt: "Tentativo", continue: "PROSEGUI", reportTitle: "Report Finale", finalStars: "Stelle Totali",
        thQ: "Domanda", thA: "Risposta Corretta", thT: "Tentativi", print: "üñ®Ô∏è STAMPA REPORT", home: "üè† HOME",
        promptName: "Sfida completata! Inserisci il tuo nome e cognome per il report:", studentLabel: "ALUNNO",
        dateLabel: "Data", createdLabel: "Creato da", challengeLabel: "Sfida"
      },
      en: {
        selectSubject: "Select Subject", resetAll: "GLOBAL RESET", backToSubjects: "‚ùÆ BACK TO SUBJECTS",
        challenges: "CHALLENGES", completed: "completed", correct: "‚ú® Correct!", wrong: "‚ùå Wrong!", 
        attempt: "Attempt", continue: "CONTINUE", reportTitle: "Final Report", finalStars: "Total Stars",
        thQ: "Question", thA: "Correct Answer", thT: "Attempts", print: "üñ®Ô∏è PRINT REPORT", home: "üè† HOME",
        promptName: "Challenge completed! Enter your full name for the report:", studentLabel: "STUDENT",
        dateLabel: "Date", createdLabel: "Created by", challengeLabel: "Challenge"
      }
    };

    let SFIDE_CARICATE = [];
    let SFIDE_PER_MATERIA = {};
    let currentSfida = null, currentMateria = null;
    let adventData = [], TOTAL_LEVELS = 0, stars = 0;

    function t(key) { return I18N[LANG][key]; }

    function setLang(l) {
      LANG = l; localStorage.setItem("lang", LANG);
      updateUI();
      if (currentSfida) caricaSfida(currentSfida);
    }

    function updateUI() {
      document.getElementById("btn-lang-it").classList.toggle("active", LANG === "it");
      document.getElementById("btn-lang-en").classList.toggle("active", LANG === "en");
      document.getElementById("ui-select-subject").innerText = t("selectSubject");
      document.getElementById("ui-reset-all").innerText = t("resetAll");
      document.getElementById("ui-back-to-subjects").innerText = t("backToSubjects");
      document.getElementById("ui-report-title").innerText = t("reportTitle");
      document.getElementById("th-q").innerText = t("thQ");
      document.getElementById("th-a").innerText = t("thA");
      document.getElementById("th-t").innerText = t("thT");
      document.getElementById("ui-print-btn").innerText = t("print");
      document.getElementById("ui-home-btn").innerText = t("home");
      
      if (document.getElementById('category-screen').style.display === 'block') renderCategories();
      if (document.getElementById('menu-screen').style.display === 'block' && currentMateria) renderMenu(currentMateria);
    }

    function renderBrand(targetId, variant) {
      const el = document.getElementById(targetId);
      if (!el) return;
      const label = variant === 'report' ? t("createdLabel") : "Creato da";
      el.innerHTML = `<div class="brand ${variant === "home" ? "brand-home" : "brand-report"}">
        <img src="${BRAND.logo}" alt="Matefacile">
        <div class="brand-text">${label} <strong>${BRAND.name}</strong> ¬∑ ${BRAND.handle} ¬∑ ¬© ${BRAND.year}</div>
      </div>`;
    }

    async function init() {
      renderBrand("brand-cat", "home");
      renderBrand("brand-home", "home");
      try {
        const resp = await fetch(URL_INDICE_SFIDE);
        const rows = parseCSV(await resp.text());
        SFIDE_CARICATE = rows.slice(1).map(r => ({
          id: r[0], titolo: r[1], titoloEN: r[5] || r[1], desc: r[2], descEN: r[6] || r[2], 
          url: r[3], urlEN: r[7] || r[3], coloreSfida: r[4] || "#bfa100",
          materia: (r[11] || "Altro").trim(), materiaEN: (r[14] || r[11]).trim(), 
          coloreMateria: r[12] || "#bfa100", ordineMateria: parseInt(r[13]) || 99
        }));
        updateUI();
      } catch (e) { document.getElementById('category-list').innerText = "Error."; }
    }

    function organizzaSfide() {
        SFIDE_PER_MATERIA = SFIDE_CARICATE.reduce((acc, s) => {
          const mKey = LANG === 'it' ? s.materia : s.materiaEN;
          if (!acc[mKey]) acc[mKey] = { sfide: [], colore: s.coloreMateria, ordine: s.ordineMateria };
          acc[mKey].sfide.push(s);
          return acc;
        }, {});
    }

    function renderCategories() {
      organizzaSfide();
      document.getElementById('category-screen').style.display = 'block';
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'none';
      document.getElementById('report-area').style.display = 'none';
      
      const list = document.getElementById('category-list');
      list.innerHTML = '';
      const sorted = Object.keys(SFIDE_PER_MATERIA).sort((a,b) => SFIDE_PER_MATERIA[a].ordine - SFIDE_PER_MATERIA[b].ordine);
      sorted.forEach(m => {
        const d = SFIDE_PER_MATERIA[m];
        const card = document.createElement('div');
        card.className = 'category-card'; card.style.backgroundColor = d.colore;
        card.innerHTML = `<h2>${m.toUpperCase()}</h2><span>${d.sfide.length} ${t("challenges")}</span>`;
        card.onclick = () => renderMenu(m);
        list.appendChild(card);
      });
    }

    function renderMenu(m) {
      currentMateria = m;
      document.getElementById('category-screen').style.display = 'none';
      document.getElementById('menu-screen').style.display = 'block';
      document.getElementById('game-screen').style.display = 'none';

      const list = document.getElementById('sfide-list');
      list.innerHTML = '';
      SFIDE_PER_MATERIA[m].sfide.forEach(s => {
        const card = document.createElement('div');
        card.className = 'sfida-card'; card.style.borderTopColor = s.coloreSfida;
        card.onclick = () => caricaSfida(s);
        card.innerHTML = `<h2 style="color:${s.coloreSfida}">${LANG === 'it' ? s.titolo : s.titoloEN}</h2><p>${LANG === 'it' ? s.desc : s.descEN}</p>`;
        list.appendChild(card);
      });
    }

    async function caricaSfida(s) {
      currentSfida = s;
      stars = parseInt(localStorage.getItem('stars_' + s.id)) || 0;
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
      document.getElementById('topic-title').innerText = LANG === 'it' ? s.titolo : s.titoloEN;
      aggiornaStelleVisive();
      try {
        const resp = await fetch(LANG === 'it' ? s.url : s.urlEN);
        const rows = parseCSV(await resp.text());
        TOTAL_LEVELS = parseInt(rows[1][1]) || 0;
        const qIdx = LANG === 'it' ? 1 : 11, aIdx = LANG === 'it' ? 10 : 20, eIdx = LANG === 'it' ? 12 : 22;
        adventData = rows.slice(4, 4 + TOTAL_LEVELS).map((v, i) => ({
          day: i + 1, question: v[qIdx] || v[1], checkAnswer: v[2], 
          answerOK: v[aIdx] || v[10], options: [v[3], v[4], v[5], v[6], v[7]].filter(o => o), spiegazione: v[eIdx] || v[12]
        }));
        render();
      } catch (e) { tornaAlMenu(); }
    }

    function render() {
      const container = document.getElementById('nodes-container');
      container.innerHTML = '';
      let solved = 0;
      adventData.forEach((d, i) => {
        const isDone = localStorage.getItem('day_' + currentSfida.id + '_' + d.day) === 'correct';
        if (isDone) solved++;
        const isFuture = (d.day > 1 && localStorage.getItem('day_' + currentSfida.id + '_' + (d.day - 1)) !== 'correct');
        const wrap = document.createElement('div');
        wrap.className = 'node-container';
        wrap.innerHTML = `<div id="node-${d.day}" class="node ${isDone ? 'done' : (isFuture ? 'future' : '')}" onclick="${isFuture ? '' : 'openQuiz('+d.day+')'}">${isDone ? '‚úî' : d.day}</div>`;
        container.appendChild(wrap);
      });
      muoviPersonaggi(solved);
      if (window.MathJax) MathJax.typeset();
      if (solved === TOTAL_LEVELS && TOTAL_LEVELS > 0) setTimeout(showReport, 1200);
    }

    function muoviPersonaggi(s) {
      setTimeout(() => {
        const achNode = document.getElementById('node-' + Math.min(s + 1, TOTAL_LEVELS));
        const tortNode = document.getElementById('node-' + Math.min(s + 2, TOTAL_LEVELS));
        const track = document.querySelector('.vertical-track');
        if (achNode && track) moveAvatar('achilles', achNode, track.getBoundingClientRect());
        if (tortNode && track) moveAvatar('tortoise', tortNode, track.getBoundingClientRect());
      }, 150);
    }

    function moveAvatar(id, node, trackRect) {
      const av = document.getElementById(id);
      const nr = node.getBoundingClientRect();
      av.style.transform = `translate(${(nr.left - trackRect.left) + (nr.width/2) - (av.offsetWidth/2)}px, ${(nr.top - trackRect.top) - av.offsetHeight + 10}px)`;
    }

    function openQuiz(day) {
      const d = adventData[day - 1];
      const cont = document.getElementById('quiz-container');
      document.getElementById('feedback-msg').innerText = "";
      let h = `<h3>${t("thQ")} ${day}</h3><p class="quiz-question">${d.question}</p>`;
      if (d.options.length > 0) {
        d.options.forEach((o, i) => { h += `<button class="btn-ans" style="background:#fff; color:#333; border:2px solid #eee;" onclick="check(${day}, '${String.fromCharCode(65+i)}', this)">${String.fromCharCode(65+i)}. ${o}</button>`; });
      } else {
        h += `<input type="text" id="ans" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px;"><button class="btn-ans" onclick="check(${day}, document.getElementById('ans').value, this)">INVIA</button>`;
      }
      cont.innerHTML = h;
      document.getElementById('modal-overlay').style.display = 'flex';
      if (window.MathJax) MathJax.typeset();
    }

    function check(day, val, btn) {
      const d = adventData[day - 1];
      const sId = currentSfida.id;
      let att = (parseInt(localStorage.getItem('tent_' + sId + '_' + day)) || 0) + 1;
      localStorage.setItem('tent_' + sId + '_' + day, att);
      if (val.trim().toLowerCase() === d.checkAnswer.toLowerCase()) {
        document.getElementById('snd-ok').play().catch(() => {});
        localStorage.setItem('day_' + sId + '_' + day, 'correct');
        animateCorrectStar(btn);
        document.getElementById('quiz-container').innerHTML = `<h2>${t("correct")}</h2><p>${d.spiegazione || ''}</p><button class="btn-ans" onclick="chiudiEProsegui()">${t("continue")}</button>`;
        if (window.MathJax) MathJax.typeset();
      } else {
        document.getElementById('snd-no').play().catch(() => {});
        animatePoop(btn);
        document.getElementById('feedback-msg').innerText = `${t("wrong")} ${t("attempt")} n. ${att}`;
      }
    }

    function animateCorrectStar(btn) {
      const star = document.createElement('div');
      star.className = 'flying-star'; star.innerText = '‚≠ê';
      const r = btn.getBoundingClientRect();
      star.style.left = (r.left + r.width/2) + 'px'; star.style.top = r.top + 'px';
      document.body.appendChild(star);
      const target = document.querySelector('#stars-count-header').getBoundingClientRect();
      setTimeout(() => { star.style.left = target.left + 'px'; star.style.top = target.top + 'px'; star.style.opacity = '0'; }, 50);
      setTimeout(() => { star.remove(); stars++; aggiornaStelleVisive(); }, 850);
    }

    function animatePoop(btn) {
      const p = document.createElement('div');
      p.className = 'exploding-poop'; p.innerText = 'üí©';
      const r = btn.getBoundingClientRect();
      p.style.left = (r.left + r.width/2 - 15) + 'px'; p.style.top = (r.top - 20) + 'px';
      document.body.appendChild(p);
      stars--; aggiornaStelleVisive();
      setTimeout(() => p.remove(), 650);
    }

    function aggiornaStelleVisive() {
      const elH = document.getElementById('stars-count-header');
      if (elH) { elH.innerText = stars; elH.style.color = stars < 0 ? "#e74c3c" : "var(--c-oro)"; }
      localStorage.setItem('stars_' + currentSfida.id, stars);
    }

    function chiudiEProsegui() { document.getElementById('modal-overlay').style.display = 'none'; render(); }

    function showReport() {
      let nome = prompt(t("promptName"));
      if (nome === null || nome.trim() === "") nome = LANG === 'it' ? "Studente" : "Student";
      document.getElementById('game-screen').style.display = 'none';
      document.getElementById('report-area').style.display = 'block';
      const dt = new Date().toLocaleDateString('it-IT') + " " + new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'});
      renderBrand("brand-report", "report");
      document.getElementById('brand-report').innerHTML += `<div style="margin: 15px auto; padding: 15px; border: 2px solid var(--c-oro); background: white; border-radius: 12px; max-width: 600px; text-align: center;">
          <h2 style="margin:0; color:var(--c-testo); font-family:'Cinzel';">${t("studentLabel")}: ${nome}</h2>
          <p style="margin:8px 0 0 0; font-size:1rem; color:#555;"><strong>${t("challengeLabel")}:</strong> ${LANG === 'it' ? currentSfida.titolo : currentSfida.titoloEN}<br><strong>${t("dateLabel")}:</strong> ${dt}</p>
        </div>`;
      document.getElementById('ui-final-stars-label').innerText = `${t("finalStars")}: ${stars}`;
      const body = document.getElementById('report-body'); body.innerHTML = '';
      adventData.forEach(d => { body.innerHTML += `<tr><td>${d.day}</td><td>${d.question}</td><td>${d.answerOK} ${d.spiegazione ? '<span class="theory-text">'+d.spiegazione+'</span>':''}</td><td>${localStorage.getItem('tent_'+currentSfida.id+'_'+d.day)||1}</td></tr>`; });
      if (window.MathJax) MathJax.typeset();
    }

    function parseCSV(csv) {
      return csv.split(/\r?\n/).filter(r => r !== "").map(row => {
        const out = []; let cur = '', inQ = false;
        for (let i = 0; i < row.length; i++) {
          let c = row[i];
          if (c === '"') { if (inQ && row[i+1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
          else if (char === ',' && !inQ) { out.push(cur.trim()); cur = ''; } // Fixed 'char' to 'c' typo
          else if (c === ',' && !inQ) { out.push(cur.trim()); cur = ''; }
          else cur += c;
        }
        out.push(cur.trim()); return out;
      });
    }

    // Correzione manuale parseCSV (rimosso il duplicato sopra)
    function parseCSV(csv) {
      return csv.split(/\r?\n/).filter(r => r !== "").map(row => {
        const out = []; let cur = '', inQ = false;
        for (let i = 0; i < row.length; i++) {
          let c = row[i];
          if (c === '"') { if (inQ && row[i+1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
          else if (c === ',' && !inQ) { out.push(cur.trim()); cur = ''; }
          else cur += c;
        }
        out.push(cur.trim()); return out;
      });
    }

    function tornaAlMenu() { if (currentMateria) renderMenu(currentMateria); else renderCategories(); }
    function resetGame() { if (confirm("Reset?")) { localStorage.clear(); location.reload(); } }
    function resetTutto() { if (confirm(LANG==='it'?"Cancellare tutto?":"Clear all?")) { localStorage.clear(); location.reload(); } }
    window.onload = init;
  </script>
</body>
</html>
