<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Didattica Hub - Sfida Achille e la Tartaruga</title>

  <meta name="author" content="Daniela Ippolito (@matefacile)">
  <meta name="copyright" content="¬© Daniela Ippolito (@matefacile)">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script>
    window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] } };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --c-oro: #bfa100;
      --c-accento: #27ae60;
      --c-sfondo: #fdfbf7;
      --c-testo: #2c3e50;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; font-family: 'Inter', sans-serif; 
      background: var(--c-sfondo); color: var(--c-testo); 
      display: flex; flex-direction: column; min-height: 100vh;
      overflow-x: hidden;
    }

    #stars-bar {
      position: fixed; top: 20px; right: 20px;
      background: white; padding: 8px 15px; border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      z-index: 2000; display: flex; align-items: center; gap: 8px;
      font-weight: bold; color: var(--c-oro); border: 2px solid var(--c-oro);
    }

    /* --- CATEGORY CARDS ASIMMETRICHE (LOOK PROFESSIONALE RICHIESTO) --- */
    #category-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 30px;
      padding: 20px;
    }

    .category-card {
      padding: 40px 20px;
      border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; /* Forma asimmetrica */
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      aspect-ratio: 1 / 1; text-align: center; color: white;
    }
    .category-card:hover { transform: scale(1.05) rotate(2deg); }
    .category-card h2 { font-family: 'Cinzel', serif; margin: 0; font-size: 1.3rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .category-card span { font-size: 0.9rem; opacity: 0.9; margin-top: 10px; }

    /* --- LAYOUT SFIDE E GIOCO (RIPRISTINATO ORIGINALE) --- */
    .sfida-card { 
      background: white; padding: 18px; border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); cursor: pointer; 
      border-top: 6px solid var(--c-oro); transition: 0.2s;
      min-height: 140px;
    }

    .vertical-track { position: relative; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; }
    .node-container { width: 100%; position: relative; z-index: 2; display: flex; margin: 18px 0; justify-content: center; }

    /* ZIG-ZAG ORIGINALE */
    .node-container:nth-child(8n+1) { transform: translateX(-110px); }
    .node-container:nth-child(8n+2) { transform: translateX(-60px); }
    .node-container:nth-child(8n+3) { transform: translateX(60px); }
    .node-container:nth-child(8n+4) { transform: translateX(110px); }
    .node-container:nth-child(8n+5) { transform: translateX(110px); }
    .node-container:nth-child(8n+6) { transform: translateX(60px); }
    .node-container:nth-child(8n+7) { transform: translateX(-60px); }
    .node-container:nth-child(8n+8) { transform: translateX(-110px); }

    .node {
      width: 55px; height: 55px; border-radius: 50%;
      background: white; border: 4px solid var(--c-oro);
      display: flex; justify-content: center; align-items: center;
      cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #ddd;
    }
    .node.done { background: var(--c-accento); color: white; border-color: #1e8449; box-shadow: 0 4px 0 #1e8449; }
    .node.future { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }

    .avatar { position: absolute; font-size: 38px; z-index: 10; transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; }

    #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 3000; }
    #modal-content { background: white; padding: 25px; border-radius: 20px; width: 92%; max-width: 500px; text-align: center; }
    .btn-ans { background: var(--c-oro); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; margin: 10px auto; width: 100%; display: block; }
  </style>
</head>

<body>

  <div id="stars-bar" style="display:none;">‚≠ê <span id="stars-count">0</span></div>

  <div id="category-screen" style="padding:40px 20px; max-width:1200px; margin:0 auto;">
    <h1 style="text-align:center; font-family:'Cinzel'; color:var(--c-oro);">Didattica Hub</h1>
    <div id="category-list">Caricamento...</div>
  </div>

  <div id="menu-screen" style="display:none; padding:40px 20px; max-width:1200px; margin:0 auto;">
    <button class="btn-ans" style="max-width:220px; background:#7f8c8d;" onclick="renderCategories()">‚ùÆ Tutte le Materie</button>
    <h1 id="selected-materia" style="text-align:center; font-family:'Cinzel'; color:var(--c-oro);">Sfide</h1>
    <div id="sfide-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px;"></div>
  </div>

  <div id="game-screen" style="display:none; flex-grow: 1;">
    <div style="padding:15px; border-bottom:3px solid var(--c-oro); background:white; display:flex; justify-content:space-between; align-items:center;">
      <button onclick="tornaAlMenu()" style="background:none; border:none; font-size:1.5rem; color:var(--c-oro); cursor:pointer;">‚ùÆ</button>
      <div style="text-align:center; flex:1;">
        <h1 id="topic-title" style="font-family:'Cinzel'; font-size:1rem; margin:0;">...</h1>
        <small id="progress-text">0/0 completati</small>
      </div>
      <button onclick="resetGame()" style="background:none; border:none; cursor:pointer;">üîÑ</button>
    </div>
    <div style="padding:40px 0;">
      <div class="vertical-track">
        <div id="achilles" class="avatar">üèÉ‚Äç‚ôÇÔ∏è</div>
        <div id="tortoise" class="avatar">üê¢</div>
        <div id="nodes-container" style="width:100%"></div>
      </div>
    </div>
  </div>

  <div id="report-area" style="display:none; padding:20px; text-align:center;">
    <h1 style="font-family:'Cinzel';">Report Finale</h1>
    <h2 id="final-stars"></h2>
    <table id="report-table" style="width:100%; border-collapse:collapse; margin-top:20px;">
      <thead><tr style="background:var(--c-oro); color:white;"><th>#</th><th>Domanda</th><th>Risposta</th><th>Tentativi</th></tr></thead>
      <tbody id="report-body"></tbody>
    </table>
    <button class="btn-ans" style="width:auto; padding:10px 40px;" onclick="esportaPDF()">üìÑ SCARICA PDF</button>
  </div>

  <div id="modal-overlay"><div id="modal-content"><div id="quiz-container"></div><div id="feedback-msg"></div></div></div>

  <script>
    const URL_INDICE_SFIDE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo9ZeS6loicyVFU04pA29n5GxEeg3q7teyh2-Tsd4DUPzwjNyQsPE4OBwG7WF14rSdxbPeTn594i1D/pub?gid=892603852&single=true&output=csv";
    
    let SFIDE_PER_MATERIA = {};
    let currentSfida = null;
    let adventData = [];
    let stars = 0;

    async function init() {
      try {
        const resp = await fetch(URL_INDICE_SFIDE);
        const rows = parseCSV(await resp.text());
        
        // Mappatura: r[11]=Materia, r[12]=Colore, r[13]=Ordine
        const sfide = rows.slice(1).map(r => ({
          id: r[0], titolo: r[1], desc: r[2], url: r[3],
          coloreSfida: r[4] || "#bfa100",
          materia: (r[11] || "Altro").trim(), 
          coloreMateria: r[12] || "#bfa100",
          ordine: parseInt(r[13]) || 99
        }));

        SFIDE_PER_MATERIA = sfide.reduce((acc, s) => {
          if (!acc[s.materia]) acc[s.materia] = { sfide: [], colore: s.coloreMateria, ordine: s.ordine };
          acc[s.materia].sfide.push(s);
          return acc;
        }, {});

        renderCategories();
      } catch (e) { console.error(e); }
    }

    function renderCategories() {
      const list = document.getElementById('category-list');
      list.innerHTML = '';
      document.getElementById('category-screen').style.display = 'block';
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'none';
      document.getElementById('stars-bar').style.display = 'none';

      // ORDINAMENTO PARAMETRICO
      Object.keys(SFIDE_PER_MATERIA).sort((a,b) => SFIDE_PER_MATERIA[a].ordine - SFIDE_PER_MATERIA[b].ordine).forEach(m => {
        const card = document.createElement('div');
        card.className = 'category-card';
        card.style.backgroundColor = SFIDE_PER_MATERIA[m].colore;
        card.innerHTML = `<h2>${m.toUpperCase()}</h2><span>${SFIDE_PER_MATERIA[m].sfide.length} Percorsi</span>`;
        card.onclick = () => renderMenu(m);
        list.appendChild(card);
      });
    }

    function renderMenu(materia) {
      document.getElementById('category-screen').style.display = 'none';
      document.getElementById('menu-screen').style.display = 'block';
      document.getElementById('selected-materia').innerText = materia;
      const list = document.getElementById('sfide-list');
      list.innerHTML = '';
      SFIDE_PER_MATERIA[materia].sfide.forEach(s => {
        const div = document.createElement('div');
        div.className = 'sfida-card';
        div.style.borderColor = s.coloreSfida;
        div.innerHTML = `<h3 style="color:${s.coloreSfida}">${s.titolo}</h3><p>${s.desc}</p>`;
        div.onclick = () => caricaSfida(s);
        list.appendChild(div);
      });
    }

    async function caricaSfida(sfida) {
      currentSfida = sfida;
      stars = parseInt(localStorage.getItem('stars_'+sfida.id)) || 0;
      document.getElementById('stars-count').innerText = stars;
      document.getElementById('stars-bar').style.display = 'flex';
      document.getElementById('menu-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';
      document.getElementById('topic-title').innerText = sfida.titolo;
      
      const resp = await fetch(sfida.url);
      const rows = parseCSV(await resp.text());
      const total = parseInt(rows[1][1]);
      adventData = rows.slice(4, 4 + total).map((v, i) => ({
        day: i + 1, question: v[1], checkAnswer: v[2], answerOK: v[10], 
        options: [v[3], v[4], v[5], v[6], v[7]].filter(o => o), spiegazione: v[12]
      }));
      renderGame();
    }

    function renderGame() {
      const container = document.getElementById('nodes-container');
      container.innerHTML = '';
      let solved = 0;
      adventData.forEach((d, i) => {
        const isDone = localStorage.getItem('day_'+currentSfida.id+'_'+d.day) === 'correct';
        if (isDone) solved++;
        const isFuture = (d.day > 1 && localStorage.getItem('day_'+currentSfida.id+'_'+(d.day-1)) !== 'correct');
        const node = document.createElement('div');
        node.className = `node-container`;
        node.innerHTML = `<div id="node-${d.day}" class="node ${isDone?'done':''} ${isFuture?'future':''}" onclick="${isFuture?'':'openQuiz('+d.day+')'}">${isDone?'‚úî':d.day}</div>`;
        container.appendChild(node);
      });
      document.getElementById('progress-text').innerText = solved + "/" + adventData.length;
      muoviAvatar(solved);
      if(window.MathJax) MathJax.typeset();
      if (solved === adventData.length) setTimeout(showReport, 1000);
    }

    function muoviAvatar(solved) {
      setTimeout(() => {
        const ach = document.getElementById('achilles');
        const tort = document.getElementById('tortoise');
        const nodeAch = document.getElementById('node-'+Math.min(solved+1, adventData.length));
        const nodeTort = document.getElementById('node-'+Math.min(solved+2, adventData.length));
        const track = document.querySelector('.vertical-track');
        if (track && nodeAch) {
            const trackRect = track.getBoundingClientRect();
            const nRect = nodeAch.getBoundingClientRect();
            ach.style.transform = `translate(${(nRect.left-trackRect.left)+(nRect.width/2)-(ach.offsetWidth/2)}px, ${(nRect.top-trackRect.top)-ach.offsetHeight+10}px)`;
        }
        if (track && nodeTort) {
            const trackRect = track.getBoundingClientRect();
            const nRect = nodeTort.getBoundingClientRect();
            tort.style.transform = `translate(${(nRect.left-trackRect.left)+(nRect.width/2)-(tort.offsetWidth/2)}px, ${(nRect.top-trackRect.top)-tort.offsetHeight+10}px)`;
        }
      }, 100);
    }

    function openQuiz(day) {
      const d = adventData[day-1];
      const cont = document.getElementById('quiz-container');
      document.getElementById('feedback-msg').innerText = "";
      let h = `<h3>Domanda ${day}</h3><p>${d.question}</p>`;
      d.options.forEach((o, i) => {
        h += `<button class="btn-ans" style="background:white; color:black; border:1px solid #ddd;" onclick="check(${day},'${String.fromCharCode(65+i)}',this)">${String.fromCharCode(65+i)}. ${o}</button>`;
      });
      cont.innerHTML = h;
      document.getElementById('modal-overlay').style.display = 'flex';
      if(window.MathJax) MathJax.typeset();
    }

    function check(day, val, btn) {
      const d = adventData[day-1];
      if (val.toLowerCase() === d.checkAnswer.toLowerCase()) {
        localStorage.setItem('day_'+currentSfida.id+'_'+day, 'correct');
        stars++; document.getElementById('stars-count').innerText = stars;
        localStorage.setItem('stars_'+currentSfida.id, stars);
        document.getElementById('quiz-container').innerHTML = `<h2>Bravo!</h2><p>${d.spiegazione||''}</p><button class="btn-ans" onclick="chiudi()">Continua</button>`;
        if(window.MathJax) MathJax.typeset();
      } else {
        stars--; document.getElementById('stars-count').innerText = stars;
        document.getElementById('feedback-msg').innerText = "Riprova!";
      }
    }

    function chiudi() { document.getElementById('modal-overlay').style.display = 'none'; renderGame(); }

    function showReport() {
      document.getElementById('game-screen').style.display='none';
      document.getElementById('report-area').style.display='block';
      document.getElementById('final-stars').innerText = "Stelle: " + stars;
      const body = document.getElementById('report-body');
      body.innerHTML = '';
      adventData.forEach(d => {
        body.innerHTML += `<tr><td>${d.day}</td><td>${d.question}</td><td>${d.answerOK}</td><td>-</td></tr>`;
      });
      if(window.MathJax) MathJax.typeset();
    }

    async function esportaPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Report: " + currentSfida.titolo, 14, 20);
      doc.autoTable({ html: '#report-table', startY: 30 });
      doc.save("Report.pdf");
    }

    function parseCSV(csv) {
      return csv.split(/\r?\n/).filter(r => r !== "").map(row => {
        const out = []; let cur = ''; let inQ = false;
        for (let i = 0; i < row.length; i++) {
          let char = row[i];
          if (char === '"') { if (inQ && row[i + 1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
          else if (char === ',' && !inQ) { out.push(cur.trim()); cur = ''; }
          else cur += char;
        }
        out.push(cur.trim()); return out;
      });
    }

    function tornaAlMenu() { renderCategories(); }
    function resetGame() { if(confirm("Resettare sfida?")) { localStorage.clear(); location.reload(); } }
    window.onload = init;
  </script>
</body>
</html>
